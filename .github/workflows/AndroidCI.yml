name: Android CI

on:
  push:
    branches: [ master ]

jobs:
  build:
    runs-on: ubuntu-latest
    if: ${{ !startsWith(github.event.head_commit.message, '[skip ci]') }}

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: 'recursive'
      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: 17
      - name: Setup Ninja
        uses: seanmiddleditch/gha-setup-ninja@master
      - name: Retrieve version
        run: |
          COMMIT_HASH=$(echo ${{ github.event.head_commit.id }} | head -c 7)
          APP_VER_NAME=$(grep '^appVerName=' gradle.properties | cut -d'=' -f2)
          echo VERSION=${APP_VER_NAME}_${COMMIT_HASH} >> $GITHUB_ENV
      - name: Write key
        if: github.event_name != 'pull_request' && github.ref == 'refs/heads/master'
        run: |
          if [ ! -z "${{ secrets.KEY_STORE }}" ]; then
            echo releaseStorePassword='${{ secrets.KEY_STORE_PASSWORD }}' >> gradle.properties
            echo releaseKeyAlias='${{ secrets.ALIAS }}' >> gradle.properties
            echo releaseKeyPassword='${{ secrets.KEY_PASSWORD }}' >> gradle.properties
            echo releaseStoreFile='${{ github.workspace }}/key.jks' >> gradle.properties
            echo ${{ secrets.KEY_STORE }} | base64 --decode > key.jks
          fi
      - name: Build with Gradle
        run: bash ./gradlew -PappVerName=${{ env.VERSION }} assembleRelease
      - name: Upload built apk
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: Zhiliao_${{ env.VERSION }}
          path: ${{ github.workspace }}/app/build/outputs/apk/release
  # 新增：发布到 GitHub Release
  release:
    needs: build  # 依赖 build 任务完成
    runs-on: ubuntu-latest
    # 条件：仅在 master 分支的普通提交（非 PR）且不是跳过 CI 的情况下执行
    if: |
      github.event_name != 'pull_request' && 
      github.ref == 'refs/heads/master' &&
      !startsWith(github.event.head_commit.message, '[skip ci]')
    
    steps:
      - name: Download APK artifact
        uses: actions/download-artifact@v4
        with:
          name: Zhiliao_${{ needs.build.outputs.version }}
          path: ./apks
      
      - name: Create GitHub Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: build-${{ github.run_id }}-${{ github.run_attempt }}
          release_name: "Build ${{ github.run_number }} - ${{ env.RELEASE_NAME }}"
          draft: false
          prerelease: false
          generate_release_notes: true  # 自动生成更新说明
          body: |
            自动构建版本 - ${{ env.RELEASE_NAME }}
            
            **构建信息:**
            - 触发提交: ${{ github.sha }}
            - 构建时间: ${{ github.event.head_commit.timestamp }}
            - 工作流运行: #${{ github.run_number }}
      
      - name: Upload APK to Release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./apks/*.apk
          asset_name: Zhiliao_${{ env.VERSION }}.apk
          asset_content_type: application/vnd.android.package-archive